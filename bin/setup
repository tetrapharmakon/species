#!/usr/bin/env bash
set -euo pipefail

# Project setup: ensure bundler is available and install gems to vendor/bundle
BUNDLER_VER=2.3.25

if ! command -v ruby >/dev/null 2>&1; then
  echo "ruby not found. Install Ruby (rbenv/asdf/system) and retry." >&2
  exit 1
fi

if ! command -v gem >/dev/null 2>&1; then
  echo "gem not found. Ensure RubyGems is installed." >&2
  exit 1
fi

if ! gem list -i bundler -v "$BUNDLER_VER" >/dev/null 2>&1; then
  echo "Installing bundler $BUNDLER_VER..."
  gem install bundler -v "$BUNDLER_VER"
fi

echo "Configuring bundler to use vendor/bundle..."
bundle _${BUNDLER_VER}_ config set --local path 'vendor/bundle'

echo "Clearing .antex-cache to force LaTeX artifacts rebuild..."
rm -rf .antex-cache

echo "Installing gems (this may take a minute)..."
bundle _${BUNDLER_VER}_ install --jobs 4 --retry 3

cat <<'EOF'
Setup complete.
To serve the site locally:
  bundle _2.3.25_ exec jekyll serve
Or use the Makefile:
  make serve
EOF
